- name: Deploy app via SSH
  run: |
    ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
      set -e
      set -x

      echo "📂 Changing to project directory..."
      cd /var/www/your-app/nodejsprojectingithub || { echo "❌ Directory not found"; exit 1; }

      echo "📁 Listing files in /mnt"
      ls -l /mnt

      echo "📄 Checking if /mnt/.env exists"
      if [ -f /mnt/.env ]; then
        echo "✅ Found /mnt/.env. Backing up existing .env..."
        [ -f .env ] && mv .env .env.bak
        cp /mnt/.env .env
      else
        echo "❌ /mnt/.env does not exist. Skipping copy."
      fi

      echo "➡ Pulling latest code from Git..."
      git fetch origin main
      git reset --hard origin/main
      git clean -fd

      echo "📦 Installing dependencies..."
      npm install

      echo "🚀 Starting or restarting app with PM2..."
      if pm2 list | grep -q "your-app"; then
        pm2 restart your-app
      else
        pm2 start app.js --name your-app
      fi

      echo "💾 Saving PM2 process list..."
      pm2 save
    EOF
